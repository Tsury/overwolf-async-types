name: Release

on:
  push:
    branches:
      - main

permissions:
  contents: write # to be able to publish a GitHub release
  issues: write # to be able to comment on released issues
  pull-requests: write # to be able to comment on released pull requests
  id-token: write # to enable use of OIDC for npm provenance

jobs:
  release:
    name: Release
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # required for commit-analyzer

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "lts/*"
          cache: "npm"

      - name: Exchange GitHub OIDC for npm token
        env:
          PACKAGE_NAME: overwolf-async-types
        run: |
          set -euo pipefail

          if [ -z "${ACTIONS_ID_TOKEN_REQUEST_TOKEN:-}" ] || [ -z "${ACTIONS_ID_TOKEN_REQUEST_URL:-}" ]; then
            echo "Missing ACTIONS_ID_TOKEN_REQUEST_TOKEN/URL (need permissions: id-token: write)" >&2
            exit 1
          fi

          AUDIENCE="npm:registry.npmjs.org"

          URL="$ACTIONS_ID_TOKEN_REQUEST_URL"
          if [[ "$URL" == *\?* ]]; then
            URL="$URL&audience=$AUDIENCE"
          else
            URL="$URL?audience=$AUDIENCE"
          fi

          OIDC_JSON=$(curl -fsSL -H "Authorization: bearer $ACTIONS_ID_TOKEN_REQUEST_TOKEN" "$URL")
          OIDC_TOKEN=$(node -e "const fs=require('fs'); const j=JSON.parse(fs.readFileSync(0,'utf8')); if(!j.value) process.exit(2); process.stdout.write(j.value);" <<< "$OIDC_JSON")

          EXCHANGE_URL="https://registry.npmjs.org/-/npm/v1/oidc/token/exchange/package/${PACKAGE_NAME}"
          NPM_JSON=$(curl -fsSL -X POST -H "Authorization: Bearer $OIDC_TOKEN" "$EXCHANGE_URL")
          NPM_TOKEN=$(node -e "const fs=require('fs'); const j=JSON.parse(fs.readFileSync(0,'utf8')); if(!j.token) process.exit(3); process.stdout.write(j.token);" <<< "$NPM_JSON")

          NPMRC_PATH="$RUNNER_TEMP/npmrc"
          {
            echo "registry=https://registry.npmjs.org/"
            echo "//registry.npmjs.org/:_authToken=${NPM_TOKEN}"
          } > "$NPMRC_PATH"
          chmod 0600 "$NPMRC_PATH"
          echo "NPM_CONFIG_USERCONFIG=$NPMRC_PATH" >> "$GITHUB_ENV"

      - name: Verify npm config
        run: |
          set -euo pipefail
          echo "Using npm userconfig: $(npm config get userconfig)"
          echo "Using npm registry: $(npm config get registry)"
          if ! grep -q "_authToken=" "$NPM_CONFIG_USERCONFIG"; then
            echo "Expected auth token in $NPM_CONFIG_USERCONFIG" >&2
            exit 1
          fi

      - name: Install dependencies
        run: npm ci

      - name: Verify the integrity of provenance attestations and registry signatures
        run: npm audit signatures

      - name: Release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: npx semantic-release
